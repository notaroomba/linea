ARM GAS  C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s 			page 1


   1              		.cpu cortex-m4
   2              		.arch armv7e-m
   3              		.fpu fpv4-sp-d16
   4              		.eabi_attribute 27, 1
   5              		.eabi_attribute 28, 1
   6              		.eabi_attribute 20, 1
   7              		.eabi_attribute 21, 1
   8              		.eabi_attribute 23, 3
   9              		.eabi_attribute 24, 1
  10              		.eabi_attribute 25, 1
  11              		.eabi_attribute 26, 1
  12              		.eabi_attribute 30, 1
  13              		.eabi_attribute 34, 1
  14              		.eabi_attribute 18, 4
  15              		.file	"BCG.c"
  16              		.text
  17              	.Ltext0:
  18              		.cfi_sections	.debug_frame
  19              		.file 1 "linea/src/BCG.c"
  20              		.section	.text.bcg_init,"ax",%progbits
  21              		.align	1
  22              		.global	bcg_init
  23              		.syntax unified
  24              		.thumb
  25              		.thumb_func
  27              	bcg_init:
  28              	.LVL0:
  29              	.LFB0:
   1:linea/src/BCG.c **** /*
   2:linea/src/BCG.c **** * Project Linea
   3:linea/src/BCG.c **** * Copyright (C) 2024 Anhang Li (thelithcore@gmail.com)
   4:linea/src/BCG.c **** * Adapted for STM32WB55 by Nathan
   5:linea/src/BCG.c **** *
   6:linea/src/BCG.c **** * This program is free software: you can redistribute it and/or modify
   7:linea/src/BCG.c **** * it under the terms of the GNU General Public License as published by
   8:linea/src/BCG.c **** * the Free Software Foundation, either version 3 of the License, or
   9:linea/src/BCG.c **** * (at your option) any later version.
  10:linea/src/BCG.c **** *
  11:linea/src/BCG.c **** * This program is distributed in the hope that it will be useful,
  12:linea/src/BCG.c **** * but WITHOUT ANY WARRANTY; without even the implied warranty of
  13:linea/src/BCG.c **** * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  14:linea/src/BCG.c **** * GNU General Public License for more details.
  15:linea/src/BCG.c **** *
  16:linea/src/BCG.c **** * You should have received a copy of the GNU General Public License
  17:linea/src/BCG.c **** * along with this program.  If not, see <http://www.gnu.org/licenses/>.
  18:linea/src/BCG.c **** */
  19:linea/src/BCG.c **** 
  20:linea/src/BCG.c **** #include "BCG.h"
  21:linea/src/BCG.c **** #include <string.h>
  22:linea/src/BCG.c **** 
  23:linea/src/BCG.c **** // Initialize BCG structure
  24:linea/src/BCG.c **** void bcg_init(bcg_t* bcg) {
  30              		.loc 1 24 27 view -0
  31              		.cfi_startproc
  32              		@ args = 0, pretend = 0, frame = 0
  33              		@ frame_needed = 0, uses_anonymous_args = 0
  25:linea/src/BCG.c ****     if (!bcg) return;
ARM GAS  C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s 			page 2


  34              		.loc 1 25 5 view .LVU1
  35              		.loc 1 25 8 is_stmt 0 view .LVU2
  36 0000 88B1     		cbz	r0, .L4
  24:linea/src/BCG.c ****     if (!bcg) return;
  37              		.loc 1 24 27 view .LVU3
  38 0002 10B5     		push	{r4, lr}
  39              		.cfi_def_cfa_offset 8
  40              		.cfi_offset 4, -8
  41              		.cfi_offset 14, -4
  42 0004 0446     		mov	r4, r0
  26:linea/src/BCG.c ****     
  27:linea/src/BCG.c ****     memset(bcg->buffer, 0, sizeof(bcg->buffer));
  43              		.loc 1 27 5 is_stmt 1 view .LVU4
  44 0006 4FF40072 		mov	r2, #512
  45 000a 0021     		movs	r1, #0
  46 000c FFF7FEFF 		bl	memset
  47              	.LVL1:
  28:linea/src/BCG.c ****     bcg->index = 0;
  48              		.loc 1 28 5 view .LVU5
  49              		.loc 1 28 16 is_stmt 0 view .LVU6
  50 0010 0023     		movs	r3, #0
  51 0012 A4F80032 		strh	r3, [r4, #512]	@ movhi
  29:linea/src/BCG.c ****     bcg->count = 0;
  52              		.loc 1 29 5 is_stmt 1 view .LVU7
  53              		.loc 1 29 16 is_stmt 0 view .LVU8
  54 0016 A4F80232 		strh	r3, [r4, #514]	@ movhi
  30:linea/src/BCG.c ****     bcg->mean = 0.0f;
  55              		.loc 1 30 5 is_stmt 1 view .LVU9
  56              		.loc 1 30 15 is_stmt 0 view .LVU10
  57 001a 0023     		movs	r3, #0
  58 001c C4F80432 		str	r3, [r4, #516]	@ float
  31:linea/src/BCG.c ****     bcg->variance = 0.0f;
  59              		.loc 1 31 5 is_stmt 1 view .LVU11
  60              		.loc 1 31 19 is_stmt 0 view .LVU12
  61 0020 C4F80832 		str	r3, [r4, #520]	@ float
  32:linea/src/BCG.c **** }
  62              		.loc 1 32 1 view .LVU13
  63 0024 10BD     		pop	{r4, pc}
  64              	.LVL2:
  65              	.L4:
  66              		.cfi_def_cfa_offset 0
  67              		.cfi_restore 4
  68              		.cfi_restore 14
  69              		.loc 1 32 1 view .LVU14
  70 0026 7047     		bx	lr
  71              		.cfi_endproc
  72              	.LFE0:
  74              		.section	.text.bcg_add_sample,"ax",%progbits
  75              		.align	1
  76              		.global	bcg_add_sample
  77              		.syntax unified
  78              		.thumb
  79              		.thumb_func
  81              	bcg_add_sample:
  82              	.LVL3:
  83              	.LFB1:
  33:linea/src/BCG.c **** 
ARM GAS  C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s 			page 3


  34:linea/src/BCG.c **** // Add a new sample to the BCG buffer
  35:linea/src/BCG.c **** void bcg_add_sample(bcg_t* bcg, uint16_t sample) {
  84              		.loc 1 35 50 is_stmt 1 view -0
  85              		.cfi_startproc
  86              		@ args = 0, pretend = 0, frame = 0
  87              		@ frame_needed = 0, uses_anonymous_args = 0
  88              		@ link register save eliminated.
  36:linea/src/BCG.c ****     if (!bcg) return;
  89              		.loc 1 36 5 view .LVU16
  90              		.loc 1 36 8 is_stmt 0 view .LVU17
  91 0000 0246     		mov	r2, r0
  92 0002 90B3     		cbz	r0, .L7
  37:linea/src/BCG.c ****     
  38:linea/src/BCG.c ****     // Add sample to buffer
  39:linea/src/BCG.c ****     bcg->buffer[bcg->index] = sample;
  93              		.loc 1 39 5 is_stmt 1 view .LVU18
  94              		.loc 1 39 20 is_stmt 0 view .LVU19
  95 0004 B0F80032 		ldrh	r3, [r0, #512]
  96              		.loc 1 39 29 view .LVU20
  97 0008 20F81310 		strh	r1, [r0, r3, lsl #1]	@ movhi
  40:linea/src/BCG.c ****     bcg->index = (bcg->index + 1) % BCG_BUFFER_SIZE;
  98              		.loc 1 40 5 is_stmt 1 view .LVU21
  99              		.loc 1 40 30 is_stmt 0 view .LVU22
 100 000c 0133     		adds	r3, r3, #1
 101              		.loc 1 40 35 view .LVU23
 102 000e 5842     		rsbs	r0, r3, #0
 103              	.LVL4:
 104              		.loc 1 40 35 view .LVU24
 105 0010 DBB2     		uxtb	r3, r3
 106 0012 C0B2     		uxtb	r0, r0
 107 0014 58BF     		it	pl
 108 0016 4342     		rsbpl	r3, r0, #0
 109              		.loc 1 40 16 view .LVU25
 110 0018 A2F80032 		strh	r3, [r2, #512]	@ movhi
  41:linea/src/BCG.c ****     
  42:linea/src/BCG.c ****     // Update count
  43:linea/src/BCG.c ****     if (bcg->count < BCG_BUFFER_SIZE) {
 111              		.loc 1 43 5 is_stmt 1 view .LVU26
 112              		.loc 1 43 12 is_stmt 0 view .LVU27
 113 001c B2F80232 		ldrh	r3, [r2, #514]
 114              		.loc 1 43 8 view .LVU28
 115 0020 FF2B     		cmp	r3, #255
 116 0022 02D8     		bhi	.L9
  44:linea/src/BCG.c ****         bcg->count++;
 117              		.loc 1 44 9 is_stmt 1 view .LVU29
 118              		.loc 1 44 19 is_stmt 0 view .LVU30
 119 0024 0133     		adds	r3, r3, #1
 120 0026 A2F80232 		strh	r3, [r2, #514]	@ movhi
 121              	.L9:
  45:linea/src/BCG.c ****     }
  46:linea/src/BCG.c ****     
  47:linea/src/BCG.c ****     // Update running statistics
  48:linea/src/BCG.c ****     if (bcg->count == 1) {
 122              		.loc 1 48 5 is_stmt 1 view .LVU31
 123              		.loc 1 48 12 is_stmt 0 view .LVU32
 124 002a B2F80232 		ldrh	r3, [r2, #514]
 125              		.loc 1 48 8 view .LVU33
ARM GAS  C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s 			page 4


 126 002e 012B     		cmp	r3, #1
 127 0030 1CD0     		beq	.L11
 128              	.LBB2:
  49:linea/src/BCG.c ****         bcg->mean = (float)sample;
  50:linea/src/BCG.c ****         bcg->variance = 0.0f;
  51:linea/src/BCG.c ****     } else {
  52:linea/src/BCG.c ****         float old_mean = bcg->mean;
 129              		.loc 1 52 9 is_stmt 1 view .LVU34
 130              		.loc 1 52 15 is_stmt 0 view .LVU35
 131 0032 D2ED815A 		vldr.32	s11, [r2, #516]
 132              	.LVL5:
  53:linea/src/BCG.c ****         bcg->mean = old_mean + ((float)sample - old_mean) / bcg->count;
 133              		.loc 1 53 9 is_stmt 1 view .LVU36
 134              		.loc 1 53 33 is_stmt 0 view .LVU37
 135 0036 07EE901A 		vmov	s15, r1	@ int
 136 003a F8EE677A 		vcvt.f32.u32	s15, s15
 137              		.loc 1 53 47 view .LVU38
 138 003e 77EEE56A 		vsub.f32	s13, s15, s11
 139              		.loc 1 53 59 view .LVU39
 140 0042 07EE103A 		vmov	s14, r3	@ int
 141 0046 B8EEC77A 		vcvt.f32.s32	s14, s14
 142 004a 86EE876A 		vdiv.f32	s12, s13, s14
 143              		.loc 1 53 30 view .LVU40
 144 004e 36EE257A 		vadd.f32	s14, s12, s11
 145              		.loc 1 53 19 view .LVU41
 146 0052 82ED817A 		vstr.32	s14, [r2, #516]
  54:linea/src/BCG.c ****         bcg->variance = bcg->variance + ((float)sample - old_mean) * ((float)sample - bcg->mean);
 147              		.loc 1 54 9 is_stmt 1 view .LVU42
 148              		.loc 1 54 28 is_stmt 0 view .LVU43
 149 0056 92ED826A 		vldr.32	s12, [r2, #520]
 150              		.loc 1 54 85 view .LVU44
 151 005a 77EEC77A 		vsub.f32	s15, s15, s14
 152              		.loc 1 54 68 view .LVU45
 153 005e 66EEA76A 		vmul.f32	s13, s13, s15
 154              		.loc 1 54 39 view .LVU46
 155 0062 76EE267A 		vadd.f32	s15, s12, s13
 156              		.loc 1 54 23 view .LVU47
 157 0066 C2ED827A 		vstr.32	s15, [r2, #520]
 158              	.LVL6:
 159              	.L7:
 160              		.loc 1 54 23 view .LVU48
 161              	.LBE2:
  55:linea/src/BCG.c ****     }
  56:linea/src/BCG.c **** }
 162              		.loc 1 56 1 view .LVU49
 163 006a 7047     		bx	lr
 164              	.L11:
  49:linea/src/BCG.c ****         bcg->variance = 0.0f;
 165              		.loc 1 49 9 is_stmt 1 view .LVU50
  49:linea/src/BCG.c ****         bcg->variance = 0.0f;
 166              		.loc 1 49 21 is_stmt 0 view .LVU51
 167 006c 07EE901A 		vmov	s15, r1	@ int
 168 0070 F8EE677A 		vcvt.f32.u32	s15, s15
  49:linea/src/BCG.c ****         bcg->variance = 0.0f;
 169              		.loc 1 49 19 view .LVU52
 170 0074 C2ED817A 		vstr.32	s15, [r2, #516]
  50:linea/src/BCG.c ****     } else {
ARM GAS  C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s 			page 5


 171              		.loc 1 50 9 is_stmt 1 view .LVU53
  50:linea/src/BCG.c ****     } else {
 172              		.loc 1 50 23 is_stmt 0 view .LVU54
 173 0078 0023     		movs	r3, #0
 174 007a C2F80832 		str	r3, [r2, #520]	@ float
 175 007e 7047     		bx	lr
 176              		.cfi_endproc
 177              	.LFE1:
 179              		.section	.text.bcg_get_mean,"ax",%progbits
 180              		.align	1
 181              		.global	bcg_get_mean
 182              		.syntax unified
 183              		.thumb
 184              		.thumb_func
 186              	bcg_get_mean:
 187              	.LVL7:
 188              	.LFB2:
  57:linea/src/BCG.c **** 
  58:linea/src/BCG.c **** // Get the current mean value
  59:linea/src/BCG.c **** float bcg_get_mean(bcg_t* bcg) {
 189              		.loc 1 59 32 is_stmt 1 view -0
 190              		.cfi_startproc
 191              		@ args = 0, pretend = 0, frame = 0
 192              		@ frame_needed = 0, uses_anonymous_args = 0
 193              		@ link register save eliminated.
  60:linea/src/BCG.c ****     if (!bcg) return 0.0f;
 194              		.loc 1 60 5 view .LVU56
 195              		.loc 1 60 8 is_stmt 0 view .LVU57
 196 0000 10B1     		cbz	r0, .L14
  61:linea/src/BCG.c ****     return bcg->mean;
 197              		.loc 1 61 5 is_stmt 1 view .LVU58
 198              		.loc 1 61 15 is_stmt 0 view .LVU59
 199 0002 90ED810A 		vldr.32	s0, [r0, #516]
 200 0006 7047     		bx	lr
 201              	.L14:
  60:linea/src/BCG.c ****     if (!bcg) return 0.0f;
 202              		.loc 1 60 22 discriminator 1 view .LVU60
 203 0008 9FED010A 		vldr.32	s0, .L15
  62:linea/src/BCG.c **** }
 204              		.loc 1 62 1 view .LVU61
 205 000c 7047     		bx	lr
 206              	.L16:
 207 000e 00BF     		.align	2
 208              	.L15:
 209 0010 00000000 		.word	0
 210              		.cfi_endproc
 211              	.LFE2:
 213              		.section	.text.bcg_get_variance,"ax",%progbits
 214              		.align	1
 215              		.global	bcg_get_variance
 216              		.syntax unified
 217              		.thumb
 218              		.thumb_func
 220              	bcg_get_variance:
 221              	.LVL8:
 222              	.LFB3:
  63:linea/src/BCG.c **** 
ARM GAS  C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s 			page 6


  64:linea/src/BCG.c **** // Get the current variance
  65:linea/src/BCG.c **** float bcg_get_variance(bcg_t* bcg) {
 223              		.loc 1 65 36 is_stmt 1 view -0
 224              		.cfi_startproc
 225              		@ args = 0, pretend = 0, frame = 0
 226              		@ frame_needed = 0, uses_anonymous_args = 0
 227              		@ link register save eliminated.
  66:linea/src/BCG.c ****     if (!bcg || bcg->count <= 1) return 0.0f;
 228              		.loc 1 66 5 view .LVU63
 229              		.loc 1 66 8 is_stmt 0 view .LVU64
 230 0000 68B1     		cbz	r0, .L19
 231              		.loc 1 66 20 discriminator 2 view .LVU65
 232 0002 B0F80232 		ldrh	r3, [r0, #514]
 233              		.loc 1 66 14 discriminator 2 view .LVU66
 234 0006 012B     		cmp	r3, #1
 235 0008 0CD9     		bls	.L20
  67:linea/src/BCG.c ****     return bcg->variance / (bcg->count - 1);
 236              		.loc 1 67 5 is_stmt 1 view .LVU67
 237              		.loc 1 67 15 is_stmt 0 view .LVU68
 238 000a 90ED827A 		vldr.32	s14, [r0, #520]
 239              		.loc 1 67 40 view .LVU69
 240 000e 013B     		subs	r3, r3, #1
 241              		.loc 1 67 26 view .LVU70
 242 0010 07EE903A 		vmov	s15, r3	@ int
 243 0014 F8EEE77A 		vcvt.f32.s32	s15, s15
 244 0018 87EE270A 		vdiv.f32	s0, s14, s15
 245 001c 7047     		bx	lr
 246              	.L19:
  66:linea/src/BCG.c ****     if (!bcg || bcg->count <= 1) return 0.0f;
 247              		.loc 1 66 41 discriminator 3 view .LVU71
 248 001e 9FED030A 		vldr.32	s0, .L21
 249 0022 7047     		bx	lr
 250              	.L20:
 251 0024 9FED010A 		vldr.32	s0, .L21
  68:linea/src/BCG.c **** }
 252              		.loc 1 68 1 view .LVU72
 253 0028 7047     		bx	lr
 254              	.L22:
 255 002a 00BF     		.align	2
 256              	.L21:
 257 002c 00000000 		.word	0
 258              		.cfi_endproc
 259              	.LFE3:
 261              		.section	.text.bcg_reset,"ax",%progbits
 262              		.align	1
 263              		.global	bcg_reset
 264              		.syntax unified
 265              		.thumb
 266              		.thumb_func
 268              	bcg_reset:
 269              	.LVL9:
 270              	.LFB4:
  69:linea/src/BCG.c **** 
  70:linea/src/BCG.c **** // Reset BCG structure
  71:linea/src/BCG.c **** void bcg_reset(bcg_t* bcg) {
 271              		.loc 1 71 28 is_stmt 1 view -0
 272              		.cfi_startproc
ARM GAS  C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s 			page 7


 273              		@ args = 0, pretend = 0, frame = 0
 274              		@ frame_needed = 0, uses_anonymous_args = 0
 275              		.loc 1 71 28 is_stmt 0 view .LVU74
 276 0000 08B5     		push	{r3, lr}
 277              		.cfi_def_cfa_offset 8
 278              		.cfi_offset 3, -8
 279              		.cfi_offset 14, -4
  72:linea/src/BCG.c ****     bcg_init(bcg);
 280              		.loc 1 72 5 is_stmt 1 view .LVU75
 281 0002 FFF7FEFF 		bl	bcg_init
 282              	.LVL10:
  73:linea/src/BCG.c **** }
 283              		.loc 1 73 1 is_stmt 0 view .LVU76
 284 0006 08BD     		pop	{r3, pc}
 285              		.cfi_endproc
 286              	.LFE4:
 288              		.text
 289              	.Letext0:
 290              		.file 2 "C:/PROGRAM FILES (X86)/ARM GNU TOOLCHAIN ARM-NONE-EABI/13.3 REL1/arm-none-eabi/include/ma
 291              		.file 3 "C:/PROGRAM FILES (X86)/ARM GNU TOOLCHAIN ARM-NONE-EABI/13.3 REL1/arm-none-eabi/include/sy
 292              		.file 4 "linea/inc/BCG.h"
 293              		.file 5 "C:/PROGRAM FILES (X86)/ARM GNU TOOLCHAIN ARM-NONE-EABI/13.3 REL1/lib/gcc/arm-none-eabi/13
 294              		.file 6 "C:/PROGRAM FILES (X86)/ARM GNU TOOLCHAIN ARM-NONE-EABI/13.3 REL1/arm-none-eabi/include/st
 295              		.file 7 "<built-in>"
ARM GAS  C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s 			page 8


DEFINED SYMBOLS
                            *ABS*:00000000 BCG.c
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:21     .text.bcg_init:00000000 $t
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:27     .text.bcg_init:00000000 bcg_init
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:75     .text.bcg_add_sample:00000000 $t
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:81     .text.bcg_add_sample:00000000 bcg_add_sample
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:180    .text.bcg_get_mean:00000000 $t
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:186    .text.bcg_get_mean:00000000 bcg_get_mean
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:209    .text.bcg_get_mean:00000010 $d
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:214    .text.bcg_get_variance:00000000 $t
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:220    .text.bcg_get_variance:00000000 bcg_get_variance
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:257    .text.bcg_get_variance:0000002c $d
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:262    .text.bcg_reset:00000000 $t
C:\Users\Nathan\AppData\Local\Temp\cc1IhnCQ.s:268    .text.bcg_reset:00000000 bcg_reset

UNDEFINED SYMBOLS
memset
